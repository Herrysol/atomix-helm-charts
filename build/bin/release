#!/bin/bash

set -x

[ "$#" -eq 2 ] || die "2 arguments required, $# provided"

repo=$1
tag=$2

git checkout master

rm -rf build/$repo

# Clone the git repo and checkout the release tag
git clone --branch master https://github.com/$repo build/$repo && \
    git -C build/$repo checkout $tag

# Package the Helm chart
helm package build/$repo/deploy/helm --destination releases

# Upload the Helm chart package
cr upload \
    --git-base-url https://api.github.com/ \
    --git-upload-url https://uploads.github.com/ \
    --owner atomix \
    --git-repo helm-charts \
    --package-path releases

# Commit the releases
echo "git add releases"
echo "git commit -a -m \"Release $repo $tag\""

# Update the repository index
cr index \
  --index-path build/index.yaml \
  --git-base-url https://api.github.com/ \
  --git-upload-url https://uploads.github.com/ \
  --owner atomix \
  --git-repo helm-charts \
  --charts-repo https://github.com/atomix/helm-charts \
  --package-path releases

# Push the updated index.yaml to GitHub pages
git checkout gh-pages
mv build/index.yaml index.yaml

echo "git commit -a -m \"Update index.yaml\""
echo "git push origin gh-pages"

git checkout master
