#!/bin/bash

if [ "$#" -lt "3" ]; then
    echo "3 arguments required, $# provided"
    exit 1
fi

set -x

repo=$1
tag=$2
branch=$(git branch --show-current)

# Switch to the master branch
git checkout master
rm -rf build/$repo
rm -r build/releases

# Clone the git repo and checkout the release tag
git clone --branch master https://github.com/$repo build/$repo && \
    git -C build/$repo checkout $tag

# Package the Helm charts
for chart in "${@:3}"
do
    helm package build/$repo/$chart --destination build/releases
done

# Upload the Helm chart releases
cr upload \
    --git-base-url https://api.github.com/ \
    --git-upload-url https://uploads.github.com/ \
    --owner atomix \
    --git-repo helm-charts \
    --package-path build/releases \
    --token $GITHUB_TOKEN

# Switch to the GitHub Pages branch
git checkout gh-pages

# Update the repository index
cr index \
    --index-path index.yaml \
    --git-base-url https://api.github.com/ \
    --git-upload-url https://uploads.github.com/ \
    --owner atomix \
    --git-repo helm-charts \
    --charts-repo https://charts.atomix.io \
    --package-path build/releases \
    --token $GITHUB_TOKEN

# Commit and push the updated index.yaml
git commit -m "Update index.yaml" index.yaml
git push origin gh-pages

# Switch back to the original branch
git checkout $branch
